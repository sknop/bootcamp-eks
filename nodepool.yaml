apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: general-purpose
spec:
  template:
    spec:
      nodeClassRef:
        group: eks.amazonaws.com
        kind: NodeClass
        name: default # Must match the metadata.name of your NodeClass

      requirements:
        - key: kubernetes.io/arch
          operator: In
          values: ["amd64"]
        - key: "karpenter.sh/capacity-type"
          operator: In
          values: ["on-demand"]
          # This says: "Always keep at least 3 on-demand nodes ready"
          # It doesn't care if they are all m5 or all r5.
          minValues: 3
        - key: "node.kubernetes.io/instance-family"
          operator: In
          values: ["m5", "r5", "m6a", "r6a"]
        - key: "node.kubernetes.io/instance-size"
          operator: In # Using 'In' is more reliable than 'NotIn' for the controller
          values: ["xlarge", "2xlarge"]
            # Optional: Expire nodes after 2 weeks to keep them fresh

      expireAfter: 336h

  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    consolidateAfter: 1m